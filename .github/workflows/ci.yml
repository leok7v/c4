name: CI

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Build c4 compiler
      run: gcc -o c4 c4.c -O3 -m64 -std=c11
    
    - name: Create build directory
      run: mkdir -p ${{ github.workspace }}/build
    
    - name: Verify build directory
      run: |
        pwd
        ls -la
        ls -la build/
        echo "Build directory created at: $(pwd)/build"
        echo "test" > build/test.txt
        cat build/test.txt
        rm build/test.txt
        echo "✓ Can write to build directory"
    
    - name: Run struct tests
      run: |
        echo "=== Testing struct/simple.c ==="
        ./c4 test/struct/simple.c
        echo "=== Testing struct/ptr.c ==="
        ./c4 test/struct/ptr.c
        echo "=== Testing struct/nested.c ==="
        ./c4 test/struct/nested.c
    
    - name: Run basic tests
      run: |
        pwd
        ls -la build/ || echo "build directory not found!"
        echo "=== Testing io.c ==="
        ./c4 test/io.c || (ls -la build/; exit 1)
        echo "Note: args.c skipped - c4 doesn't properly support argv for interpreted programs"
    
    - name: Test self-compilation
      run: |
        echo "=== Self-compiling c4 ==="
        ./c4 c4.c
    
    - name: Run all tests summary
      run: |
        failed=0
        for test in test/struct/*.c; do
          echo "Testing $test..."
          if ! ./c4 "$test" > /dev/null 2>&1; then
            echo "FAILED: $test"
            failed=$((failed + 1))
          fi
        done
        
        if [ $failed -eq 0 ]; then
          echo "✓ All struct tests passed!"
        else
          echo "✗ $failed test(s) failed"
          exit 1
        fi
