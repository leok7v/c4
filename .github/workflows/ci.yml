name: CI

on:
  workflow_dispatch: # Enables manual trigger in the Actions tab
# push:
#   branches: [ master, main ]
# pull_request:
#   branches: [ master, main ]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Create build directory
      run: mkdir -p build

    - name: Build c4 compiler
      run: clang -o build/c4 c4.c -O3 -m64 -std=c11 -w
    
    
    - name: Run tests
      run: |
        set +e
        output=$(build/c4 test/test.c 2>&1)
        exit_code=$?
        set -e
        echo "$output"
        summary_line=$(echo "$output" | grep 'SUMMARY:' | tail -1)
        if [ -n "$summary_line" ]; then
          passed=$(echo "$summary_line" | awk -F'[ /]' '{print $2}')
          total=$(echo "$summary_line" | awk -F'[ /]' '{print $3}')
          failed=$((total - passed))
        else
          failed=1  # No summary = failure
        fi
        if [ "$failed" -eq 0 ] && [ "$exit_code" -eq 0 ]; then
          echo "All tests passed!"
        else
          echo "$failed test(s) failed (exit_code=$exit_code)"
          exit 1
        fi
